[Addon Change log](/addonfile?addon=Dirst___The_earth_strikes_back&file=addon_changes.md)
![The_earth_strikes_back Haiku](http://conqueringnetherlands.files.wordpress.com/2012/12/image31.jpg)
## So you think that you need some help, want to do a sugestion, inform about a bug or give thanks to modders or developpers, but not sure where to go.
1. If you want to patronize Toady One and the developpment of Dwarf Fortress go to: [Support Dwarf Fortress Vanilla](http://www.bay12games.com/support.html)
2. For questions about the rubble framework go to: [Rubble framework](http://www.bay12forums.com/smf/index.php?topic=154304.0)
3. Anything about HDFPS: Humble Dwarf Fortress Publishing System is there [HDFPS](http://www.bay12forums.com/smf/index.php?topic=157300.0)
4. If your question is addressed to the actual original maintainer of this mod then you have [The_earth_strikes_back](http://www.bay12forums.com/smf/index.php?topic=144831.0)!

# This is a Rubble port of The Earth Strikes Back! mod.

Some features of the original mod are not supported directly by this addon pack:

* Stone Sense support is not installed, you can install this manually from the normal (non-Rubble) version if desired.

Milo managed to make the initial port without using any Rubble features that are not part of the Rubble core functionality, so this addon should be compatible with any newer Rubble version (and should continue to be compatible into the future).

<hr>

A mod for Dwarf Fortress v0.42

Version 2.02

<A HREF="http://dffd.wimbli.com/file.php?id=9915">Non-Rubble Version on DFFD</A>

<A HREF="http://www.bay12forums.com/smf/index.php?topic=144831">Forum thread</A>


## Requirements ##

- Dwarf Fortress v42.04 or later

- DFHack 42.04r1 or later

Previous version for Dwarf Fortress v0.40 is available at https://www.dropbox.com/sh/8lwraiy7v7jkifv/AADqFKPo1SCZtQSxp184MeN1a?dl=0

This mod includes new creatures, some new high-value gems to balance the risk posed by the new creatures, new workshops to mitigate the risks, exotic new plants as a side-effect of the new creatures' and gems' origins, and graphics for both Stonesense and the main interface.


## Background ##

The world is flush with life, anywhere and everywhere we witness an endless variety of living things.  Not only do we see birds in the sky, beasts on the ground and fish in the sea, but ancient trees burrow into the earth itself for sustenance.  Some, such as the Dwarves and Goblins, are aware that life is as boundless below the surface as above it, filling great caverns with fantastic plants and animals and peoples.  Life, it seems, is everywhere.

From where does all of this life come?  Doubtless the gods forged it originally, striking upon the anvil of the world with unimaginable crafts to create the infinite variety of living things we see today.  To those races that have tamed even the simplest metals, it is obvious that the seas and the soil are too soft a foundation upon which to forge anything of consequence... life must have been forged on solid rock.  But we do not need to take this on faith... the Dwarves who mine into solid rock know that this is true.

When the gods forged the first life, their strikes were of such incredible force that even the forgotten embers possessed power beyond mortal comprehension.  These embers, buried deep within the rock, imbue the surrounding stone with the dignity and vigor of a living thing.  Fresh, hot embers are surrounded by Living Stone that can be quite dangerous if awakened by careless mining.  The smaller embers have cooled leaving behind Hidden Gems where they otherwise would not be expected.

Any miner knows that the surest way to prosperity is to strike the earth.  Wise miners know that sometimes the earth strikes back.


## Features ##

### Hidden Gems ###

High-value gems lie hidden within the layer stones, and there is one Hidden Gem type for each of the 24 types of standard layer stone (the 25th and 26th, obsidian and slade, are special enough already).  They resemble common gems, but all are precious due to their special origins.  For example, Hidden Onyx is found within limestone and is much more valuable than common onyx.

### Living Stone ###

Some stone still burns with enough animating force to react when struck by a pick, and this is when an Awakened Stone pulls itself free of the rock to attack the miner.

### Awakened Stones ###

A bewildering hybrid of flesh and stone, an Awakened Stone appears to be a boulder with a face and four long, clawed arms.  The core of this creature is nerve and muscle and bone, but it is covered in a thick layer of stone and has mud running through its veins.  Had it been left in peace, its iridescent eyes would have eventually solidified into Hidden Gems.  A single Awakened Stone is no match for a prepared militia, but these creatures usually turn up deep in the mines where the only protection comes from the miner's pick.

### Tributes and Secrets ###

Fortunately, Dwarves have learned how to pacify Living Stone so that the Awakened Stones that emerge are tame.  This is accomplished by researching a Secret (like necromancy, but less icky) or building a Tribute workshop from three blocks of that layer stone and sacrificing a gem.  Each miner that learns the Secret or sacrifices an appropriate gem at the Tribute will usually be at peace with any Living Stone he or she awakens.  An appropriate sacrifice is expensive: either a large gem or any cut gem of that layer's Hidden Gem.

A Secret or Tribute is specific to a miner and a layer stone.  A miner who has made Tribute to Limestone will be at peace with any new Awakened Limestones he or she frees from the rock, but would still be considered an enemy by Awakened Granite.  Another miner from the same fortress would anger an Awakened Limestone unless he or she also made an appropriate sacrifice.

### Awakened Magma and Incandescent Stones ###

Living Stone that was unlucky enough to be awakened by magma is similar to an Awakened Stone, except that it is red-hot with heat and anger.  Tributes are of no use pacifying these creatures because they were not awakened by miners.  Living Stone that melts in magma becomes Awakened Magma, while "magma-safe" Living Stone becomes Incandescent Stone.

### Wyrms ###

Embers of creation that have cooled leave Hidden Gems, those that are still warm leave Awakened Stones, and the hottest ones leave an egg that hatches into a fast-growing Wyrm.  Although it hatches about the same size as an Awakened Stone, it will be the size of a dragon within a month.

Unlike Awakened Stones, these embers burn so hot that most of a Wyrm remains organic after it is slain.  Unfortunately, these hot embers are very difficult to pacify with Tribute.  A Dwarf who has made an appropriate sacrifice at a Tribute does not calm a Wyrm, but at least the beast won't be berserk when it emerges.  Usually.

### Awakened Storms ###

Embers of creation that fall onto a lake or river simply burn their way through to the rock below, but an Ember that falls into the ocean stays in contact with the water long enough to affect it.  The boiling region rises above the surface to form a swirling mass of clouds and lightning that can be devastating to a coastal settlement.

### Gem Seeds and Gem Vines ###

The boundary between animate Living Stone and inanimate Hidden Gem is not always simple or obvious.  Some Hidden Gems still contain enough force that they can be coaxed back to life.  A dwarf can attempt to extract a Gem Seed from a Hidden Gem at an appropriate Tribute.  If the extraction is successful, the Gem Seed can be planted to produce Gem Vines that can be brewed into alcohol and occasionally produce more Hidden Gems.

### Pet Rocks ###

People often take comfort from talking to their plants or pets, even if there is no obvious response.  Some people have adopted bits of Living Stone as their conversation partners... at least they believe they are talking to Living Stone.  It is very difficult to tell Living Stone apart from regular stone.

### DFHack Scripts ###

The mod includes eight DFHack scripts: tesb-attack, tesb-create-unit, tesb-mining, tesb-prospect, tesb-create-unit, tesb-tame-all, tesb-wake, and tesb-weather.

The tesb-prospect and tesb-create-unit scripts are deprecated in this version.  Running one will only produce a message stating that it is deprecated.

The remaining scripts are used internally, but they can be entered into the DFHack console if desired.  Use with "-help" for parameters (except for tesb-tribute which does not accept any parameters anyway).


## Installation ##

To use these addons simply place the addon pack (without unzipping it!) into your Rubble addons directory, then generate as normal selecting the `addon:The Earth Strikes Back!` addon.

This mod includes several configration variables to customize your experience.

- Creature graphics may toggled be ON or OFF
- Secrets may be toggled ON or OFF
- Gem vines may be toggled ON or OFF
- Pet rocks may be toggled ON or OFF (but who could every toggle off such adorable creatures?)
- Living stone may be set to COMMON, RARE or NEVER
- Hidden gems may be set to COMMON, RARE or NEVER

Setting living stone to NEVER prevents anything from appearing while mining, and disables all of the creatures other than pet rocks.  Setting hidden gems to NEVER has the side-effects of disabling plants and turning Wyrm eyes into common gems.  If living stone and hidden gems are *both* set to NEVER, then Tributes have no function and are disabled.



## Future Development Plans ##

1. Leverage new DF 0.42 features.
2. Contribute to research on fixing spawned creature behavior.
3. Make the graphics a little less embarassing.


## Reference ##

### Hidden Gems ###

All Hidden Gems are precious (material value 40) and can be used normally for gemcutting and encrusting once mined.  However, when they are still in the ground their unmined tiles are indistinguishable from the layer stone around them, even to DFHack tools like prospect and reveal.  A notification such as "You have struck hidden amethyst!" will be generated whenever a Hidden Gem is found.  There are twenty-four types of Hidden Gem, one for each of the main layer stones in the game (the 25th and 26th, obsidian and slade, are special enough on their own).

<span style="color:#808000">&diams;</span>	Hidden amber opal is found in sandstone.

<span style="color:#800080">&diams;</span>	Hidden amethyst is found in gabbro.

<span style="color:#00FFFF">&diams;</span>	Hidden aquamarine is found in schist.

<span style="color:#FFFF00">&diams;</span>	Hidden beryl is a golden-yellow-colored gem found in marble.

<span style="color:#808080">&diams;</span>	Hidden black opal is found in dolomite.

<span style="color:#C0C0C0">&diams;</span>	Hidden bone opal is a beige-colored gem found in siltstone.

<span style="color:#FF0000">&diams;</span>	Hidden cherry opal is a chestnut-colored gem found in rock salt.

<span style="color:#00FF00">&diams;</span>	Hidden emerald is found in granite.

<span style="color:#FF0000">&diams;</span>	Hidden fire opal is a scarlet-colored gem found in mudstone.

<span style="color:#000080">&diams;</span>	Hidden garnet is a blue-colored gem found in gneiss.

<span style="color:#FFFFFF">&diams;</span>	Hidden milk opal is a cream-colored gem found in claystone.

<span style="color:#808080">&diams;</span>	Hidden onyx is a blank and white gem found in limestone.  Like normal onyx, it is colored "black" for game purposes.

<span style="color:#FFFFFF">&diams;</span>	Hidden pinfire opal is a flax-colored gem found in conglomerate.

<span style="color:#FFFF00">&diams;</span>	Hidden pyrite is a silver-colored gem found in dacite.

<span style="color:#808080">&diams;</span>	Hidden pyrope is a dark-red-colored gem found in slate.  Like normal black pyrope, it is colored "black" for game purposes.

<span style="color:#FFFFFF">&diams;</span>	Hidden quartz is a cream-colored gem found in andesite.

<span style="color:#C0C0C0">&diams;</span>	Hidden shell opal is an ivory-colored gem found in shale.

<span style="color:#800080">&diams;</span>	Hidden spinel is a purple-colored gem found in diorite.

<span style="color:#FFFF00">&diams;</span>	Hidden sunstone is a red gem with yellow flecks found in basalt.  Like normal sunstone, it is colored "pumpkin" for game purposes.

<span style="color:#000080">&diams;</span>	Hidden tourmaline is an indigo-colored gem found in quartzite.

<span style="color:#00FFFF">&diams;</span>	Hidden turquoise is found in rhyolite.

<span style="color:#808000">&diams;</span>	Hidden wax opal is a flax-colored gem found in chert.

<span style="color:#FFFFFF">&diams;</span>	Hidden white opal is found in chalk.

<span style="color:#800000">&diams;</span>	Hidden zircon is a red-colored gem found in phyllite.

Note that material preferences for Hidden Gems are unrelated to the normal gems with similar names.  That is, a Dwarf with a preference for amethyst will not be impressed by hidden amethyst, and vice versa.  This is due to the same system that makes "gold" and "native gold" unrelated preferences in the vanilla game.

Technical details

Each Hidden Gem has its attributes copied from the vanilla version of the normal gemstone, which might make for slight color differences depending on your graphics pack.  Since v1.30 these gems are not present as clusters on the map, rather there is a small chance of a rough Hidden Gem being generated each time a tile of layer stone is mined.


### Living Stone ###

When a tile of Living Stone is mined, the resulting boulder animates into an Awakened Stone or Wyrm.  Whether that creature is friendly or hostile depends on whether the miner performed a sacrifice at an appropriate Tribute.

Technical details

Since v1.30 there are no clusters of Living Stone the map, rather there is a small chance of spawning an Awakened Stone or Wyrm (and possibly some Pet Rocks) each time a tile of layer stone is mined.


### Awakened Stones ###

When Living Stone is disturbed by mining, it attempts to tear itself free of the surrounding rock to move about on its own.  You will receive an announcement like "Urist McMiner has awakened a creature of Living Limestone" if the miner previously made a sacrifice at an appropriate Tribute, and the Awakened Stone will be tame.  Otherwise you will receive an announcement like "Urist McMiner has incurred the wrath of an Awakened Limestone", and the Awakened Stone will be hostile.  There is a one-in-ten chance that a hostile Awakened Stone will be berserk.  If an Awakened Stone is hostile, it will remain hostile even if it later meets a Dwarf who made an appropriate Tribute.

An Awakened Stone appears to be a boulder with a face and four long, clawed arms.  Its surface is made of rock and its blood is mud, but while still animated it has organic fleshy innards with familiar bones and organs.  Upon death, an Awakened Stone reverts quickly to a normal boulder.

In combat, an Awakened Stone is much more likely to bite than it is to use its claws.  Tame specimens can be trained for hunting or war, but they cannot breed.  Awakened Stones have a high running speed (60kph) but accelerate slowly, and they are not slowed down as much as other creatures by climbing or crawling (19kph).  They are also low-level building destroyers (able to destroy archery targets, slabs, statues, windows, wooden doors, and wooden hatches), making it that much harder to slow them down.

The creature tile for an Awakened Stone is â (although this will only be visible if the creature graphics are disabled).  The tile color is brown, dark gray, gray, light gray, or white depending on the stone type.

Technical details

All 24 types of Awakened Stones are castes of the same TESB_AWAKENED_STONE creature.  The creature's tile color varies by caste, but unfortunately it was not possible to make all of them visually distinct.  Stonesense does a better job of distinguishing Awakened Stones from one another, and it even respects castes that come in a variety of surface colors.

The TESB_AWAKENED_STONE creature appears very rarely in the caverns, but it doesn't appear directly due to mining at worldgen sites.  This means that Legends will be rarer than might be expected from their appearance at player forts.


### Tributes ###

A Tribute is a 3x3 workshop constructed from three blocks of a layer stone.  The Masonry labor is required to construct a Tribute and the Mining labor is required to perform sacrifices at one.  These sacrifices are very expensive, so it is recommended that a Manager be used to assign a specific miner to the workshop to ensure that the intended Dwarf performs the sacrifice.

Each Tribute allows two reactions, either of which has the same effect upon the Dwarf performing the reaction.  The first reaction (shortcut lowercase-L) consumes a large gem, and the second one (shortcut lowercase-H) consumes a normal cut gem of the Hidden Gem associated with that stone.  For example, the Tribute to Marble allows "Sacrifice large gem (l)" and "Sacrifice hidden beryl (h)".

The Dwarf performing the sacrifice will be permanently affected by a syndrome (e.g., "marble favor") that has two effects.  The first effect is to reduce the hostility of any Awakened Stones or Wyrms that the Dwarf releases from Living Stone.  The second effect is that the Dwarf suffers half-damage from anything made of that stone, including falling onto a floor of that material.  Repeated sacrifices do not further reduce the damage.

The third reaction available at a Tribute attempts to extract a Gem Seed from a rough Hidden Gem, with a shortcut key of lowercase-X.  For example, the Tribute to Marble allows "Extract hidden beryl seed (x)".  The attempt _always_ destroys the rough Hidden Gem and produces a usable Gem Seed 50% of the time.

Technical details

A Tribute can be constructed from any three blocks, but it will function only if it is constructed from three blocks of the same layer stone.  A non-functional Tribute can be deconstructed to recover the blocks.  The tesb-tribute script allows all 24 Tribute types to appear on the building menu as a single generic Tribute building; this is accomplished by converting a generic Tribute into a specific Tribute workshop based on its materials.

The script that spawns Awakened Stones (and Wyrms) determines if the miner is affected by the appropriate "favor" syndrome and causes the Awakened Stone to spawn as tame if the "favor" syndrome is present and hostile otherwise ("favor" affects Wyrms to a lesser extent).  The script, tesb-wake, can be run from the DFHack console.  Type "tesb-wake -help" at the console for more information.

A cloud of blue mist appears when a sacrifice is performed at a Tribute.  This requires temperature to be turned on but is entirely cosmetic; the syndrome is applied through a reaction-trigger in DFHack, so there is no dependence on the Dwarf inhaling gas to contract the "favor" syndrome.


### Secrets ###

A person can also gain the "favor" syndrome by learning a divine Secret.  The Secret can be written down and learned by others, but unlike necromancy the holders of these secrets do not build towers.  Learning one of the Secrets does not prevent learning the others, so in principle a migrant can arrive who is already at peace with several types of Living Stone.

	Sedimentary stones are in the EARTH and MINERALS Spheres.  Rock salt is also in the SALT Sphere.
	Metamorphic stones are in the EARTH and MOUNTAINS Spheres.
	Igneous intrusive stones are in the MOUNTAINS and CAVERNS Spheres.
	Igneous extrusive stones are in the MOUNTAINS and VOLCANOS Spheres.
	Flux stones are in the MINERALS and METALS Spheres.

Technical details

Those who learn the secret of peace with a particular kind of Living Stone do not establish towers, so the slabs and books detailing the secret will be stored wherever the person happens to live.  Due to current peculiarities of DF, the same people who seek out these secrets of peace are the same ones trying to become necromancers, and some people accomplish both.  Anyone can learn the secret by reading a (divine) slab or (mundane) book, if they can find one.  Fortunately for the player, necromancers do not migrate to forts.  This means that migrants with these secrets are likely only on worlds that are young (first generation still living) or very, very old (allowing enough time for writings to be lost and rediscovered).


### Awakened Magma and Incandescent Stones ###

These creatures were Living Stone awakened by natural causes, and as such there is no opportunity to calm them with Tributes.  In fact, these creatures are perpetually angry and completely untrainable.

They are also as hot as magma and always on fire.  The difference between Awakened Magma and Incandescent Stone is that the former has a molten surface while the latter has a red-hot solid surface of magma-safe stone (Basalt, Chert, Dolomite, Gabbro, Quartzite or Sandstone).  They are at home in subterranean magma formations, but often wander across the land in search of prey.

Technical details

The TESB_AWAKENED_MAGMA and TESB_INCANDESCENT_STONE creatures are very similar to the TESB_AWAKENED_STONE creature except that they occur naturally and immolate their surroundings.  Another important difference is that more than one can appear at a time.


### Wyrms ###

A Wyrm resembles a wingless dragon, although it is covered in rock instead of scales.  These fast-growing beasts attack with their bites, claws and tails, and fortunately lack the fiery breath attack of their look-alikes.  Born about the size of an Awakened Stone, a Wyrm quadruples in size each week for four weeks to roughly the size of a dragon.  The initial miner who released the Wyrm will probably have the best chance to kill it.  Any Living Stone hot enough to emerge as a Wyrm will be hostile, but the creture is much less likely to be berserk if the miner had previously made an appropriate Tribute.

These fast-growing beasts attack with their bites, claws and tails, and have special attacks that vary depending on their type:
- Aquifer-bearing stones have a bite that causes all fat tissue to swell up (as it fills with water).
- Igneous extrusive stones can slap the ground with their tail, staggering nearby foes.
- Igneous intrusive stones can spit magma.
- Flux stones have steel for bones, teeth, and their oversized claws.
- The remaining Wyrms spit rocks quite often.

Technical details

All Wyrms are castes of the same TESB_WYRM creature.  When butchered, each eye yields a rough Hidden Gem.  The chance that an [b]Awakened Stone[/b] will turn out to be a Wyrm is the square root of the chance of a tile yielding an Awakened Stone.  At the default rate of .002 of tiles yielding Awakened Stones, 4.47% (about 1 in 22) will turn out to be Wyrms.


### Awakened Storms ###

An Awakened Storm is a huge, dense formation of clouds with four swirling arms around a central core.  These arms will batter and lash nearby creatures, but the lightning that surrounds them will strike any creature in the vicinity.  Lightning is far more dangerous to creatures standing in water, and that is likely because it is always raining when an Awakened Storm arrives.

An Awakened Storm does not have any vital organs, so killing it requires disrupting its core.  Once that is accomplished, you will be rewarded with a special Hidden Gem that cannot be acquired through mining.

Technical details

The TESB_AWAKENED_STORM is a "naturally" occuring beast native to the oceans, and the tesb-weather script checks for the presence of one every ten ticks.  If one is found, the script sets the weather to rain.


### Gem Seeds and Gem Vines ###

If the fortress extracts a Gem Seed from a rough Hidden Gem at a Tribute, that seed can be planted in an underground farm plot to produce a Gem Vine.  Each type of Hidden Gem has its own species of Gem Vine. The growths of this plant, known as "clusters," can be processed at a Still to produce 5 units of alcoholic "spirits" and a 20% chance of recovering a rough Hidden Gem.  For example, an amethyst seed can grow into an amethyst vine which produces amethyst clusters; those clusters can be brought to a Still to produce amethyst spirits and possibly a rough hidden amethyst.

The reaction at the Still is "brew gem cluster (g)" and requires a barrel or pot to hold the spirits.

Technical details

There are twenty-four separate species of Gem Vines which are largely identical except for coloration.  The clusters are rocky and inedible, having no value other than being processed at a Still.  The structural material and seeds, however, are normal plant products that are vulnerable to vermin.  The seeds can be cooked into meals if permitted in the Kitchen settings.

The clusters and seeds were given high materials values because (1) they can produce an endless stream of precious gems and (2) they should not be available for embark under normal circumstances.


### Pet Rocks ###

These small pets are very low-maintenance because rocks don't eat or drink.  Unfortunately, they will not move unless picked up by a dwarf.  Pet Rocks should be pastured in meeting areas to make them more likely to be adopted, then released from the pasture in case the owner wishes to bring the new pet to work.  If any Pet Rock ever did anything, no one witnessed it.


Technical details
The TESB_PET_ROCK creature is classified as vermin so that its owner can carry it around (because otherwise a Pet Rock is utterly immobile), which also has two side effects.  First, vermin spawn in random spots around the fort.  Second, embarking with vermin pets is bugged so they need to be caught in the wild and trained.  Since immobile vermin would be... ahem... unlikely to fall into a trap for eventual domestication, a script affects them as they spawn, turning each one into a tame animal associated with the fort or adventurer.

There is a chance that a Pet Rock or two will spawn alongside an Awakened Stone or Wyrm when Living Stone is mined.


### DFHack Scripts ###

tesb-attack is a fallback in case Roses' attack script is not present.

tesb-create-unit is deprecated because create-unit is now a standard part of DFHack (but see Known Bugs below).

tesb-mining is used in spawning Hidden Gems, Awakened Stones, Wyrms and Pet Rocks while mining.  It is  intended for use from onload.init and not from the console.

tesb-prospect is deprecated in this version of The Earth Strikes Back.  Hidden Gems and Living Stone now co-occur with layer stones, so there is no need to look for them specifically.

tesb-tame-all is used in managing Pet Rocks.  It is intended for use from onload.init and not from the console.

tesb-tribute is discussed in the technical details for Tributes.

tesb-wake is discussed in the technical details for Tributes.

tesb-weather is used to force rain when an Awakened Storm is on the map.



### Change log ###

[Change log](/addonfile?addon=The%20Earth%20Strikes%20Back%21&file=addon_changes.md)


### Known bugs ###

The v0.42.04r1 and v0.42.05-alpha1 DFHack create-unit script is bugged such that spawned creatures always appear "friendly" on the unit screen.  Changes planned for the next version will make them proper wild animals, but may cause problems if the player embarks in the northwest corner of the world map.

The only secrets learned during worldgen are associated with the goal of Immortality, so the Peace with Living Stone secrets are associated with Immortality.  Will be changed to Bring Peace to the World when DF allows other goals in worldgen.  This mod's secrets do not interfere with the same person becoming a necromancer.  
